// helpers generales 
function isEmpty(value) {
    return value === null || value === undefined || (String(value).trim() === "");
}

function isValidEmail(email) {
    if (isEmpty(email)) return false;
    email = String(email).trim();
    var re = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i;
    return re.test(email);
}

function setMessage(targetId, message, isOk) {
    var el = document.getElementById(targetId);
    if (!el) return;

    el.className = "msg " + (isOk ? "msg-ok" : "msg-error");
    el.innerText = message;
    el.style.display = "block";
}

function clearMessage(targetId) {
    var el = document.getElementById(targetId);
    if (!el) return;
    el.style.display = "none";
    el.innerText = "";
    el.className = "msg";
}

function toLocalIsoMinute(date) {
    // yyyy-MM-ddTHH:mm
    var pad = n => String(n).padStart(2, '0');
    return date.getFullYear() + "-" + pad(date.getMonth() + 1) + "-" + pad(date.getDate()) +
        "T" + pad(date.getHours()) + ":" + pad(date.getMinutes());
}

// Registration page behavior moved from Registro.aspx
$(function(){

  function validateForm(){
    clearMessage("msgRegister");

    var idType = $("#idType").val();
    var idNumber = $("#idNumber").val();
    var firstName = $("#firstName").val();
    var lastName = $("#lastName").val();
    var birthDate = $("#birthDate").val();
    var filialNumber = $("#filialNumber").val();
    var email = $("#email").val();
    var password = $("#password").val();
    var confirmPassword = $("#confirmPassword").val();
    var terms = $("#terms").is(":checked");

    var ok =
      !isEmpty(idType) &&
      !isEmpty(idNumber) &&
      !isEmpty(firstName) &&
      !isEmpty(lastName) &&
      !isEmpty(birthDate) &&
      !isEmpty(filialNumber) &&
      isValidEmail(email) &&
      !isEmpty(password) &&
      password === confirmPassword &&
      terms;

    $("#btnRegister").prop("disabled", !ok);
    return ok;
  }

  function renderUsers(users){
    var $tbody = $("#tblUsers tbody");
    $tbody.empty();

    users.forEach(function(u){
      var tr = $("<tr/>");
      tr.append($("<td/>").text(u.email));
      tr.append($("<td/>").text(u.firstName + " " + u.lastName));
      tr.append($("<td/>").text(u.filialNumber));
      tr.append($("<td/>").text(u.role));
      $tbody.append(tr);
    });
  }

 function loadUsers() {
  // Use ASP.NET PageMethods to call the page static WebMethod and ensure proper headers/session
  PageMethods.GetUsers(function(r){
    if (r && r.ok) {
      renderUsers(r.data || []);
    } else {
      setMessage("msgRegister", (r && r.message) ? r.message : "Error al cargar usuarios.", false);
    }
  }, function(err){
    // err is an error object provided by ASP.NET AJAX
    setMessage("msgRegister", "Error Ajax GetUsers: " + (err && err.get_message ? err.get_message() : "Comunicación"), false);
    console && console.log(err);
  });
}

  $("#idType, #idNumber, #firstName, #lastName, #birthDate, #filialNumber, #hasConstruction, #email, #password, #confirmPassword, #terms")
    .on("input change", validateForm);

  $("#btnClear").on("click", function(){
    $("#idType").val("");
    $("#idNumber").val("");
    $("#firstName").val("");
    $("#lastName").val("");
    $("#birthDate").val("");
    $("#filialNumber").val("");
    $("#hasConstruction").val("true");
    $("#email").val("");
    $("#password").val("");
    $("#confirmPassword").val("");
    $("#terms").prop("checked", false);
    clearMessage("msgRegister");
    validateForm();
  });

  $("#btnRegister").on("click", function () {
  if (!validateForm()) {
    setMessage("msgRegister", "Revise los campos. Hay información inválida o incompleta.", false);
    return;
  }

  var dto = {
    idType: $("#idType").val(),
    idNumber: $("#idNumber").val(),
    firstName: $("#firstName").val(),
    lastName: $("#lastName").val(),
    birthDate: $("#birthDate").val(),
    filialNumber: parseInt($("#filialNumber").val(), 10),
    hasConstruction: ($("#hasConstruction").val() === "true"),
    email: $("#email").val(),
    password: $("#password").val()
  };

  registerUser(dto);
});

    function registerUser(dto) {
  PageMethods.RegisterUser(dto, function(r){
    if (r && r.ok) {
      setMessage("msgRegister", r.message, true);
      loadUsers();
      $("#btnClear").click();
    } else {
      setMessage("msgRegister", (r && r.message) ? r.message : "Error al registrar.", false);
    }
  }, function(err){
    setMessage("msgRegister", "Error Ajax RegisterUser: " + (err && err.get_message ? err.get_message() : "Comunicación"), false);
    console && console.log(err);
  });
 }

  //Inicializo usuarios y formulario
  validateForm();
  loadUsers();
});